
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tang-jiapeng.github.io/core/cmu10-714/lecture4/">
      
      
        <link rel="prev" href="../lecture3/">
      
      
        <link rel="next" href="../lecture5/">
      
      
      <link rel="icon" href="../../../logo.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>Lecture4：Automatic Differentiation - 0X10CC's notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Serif SC";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/timeago.css">
    
      <link rel="stylesheet" href="../../../from_oi_wiki/css/extra.css?v=13">
    
      <link rel="stylesheet" href="../../../css/status.css">
    
      <link rel="stylesheet" href="../../../css/neoteroi-mkdocs.css">
    
      <link rel="stylesheet" href="../../../termynal.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-JT9BRCXKJJ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-JT9BRCXKJJ",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-JT9BRCXKJJ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#automatic-differentiation" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="0X10CC&#39;s notes" class="md-header__button md-logo" aria-label="0X10CC's notes" data-md-component="logo">
      
  <img src="../../../logo.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            0X10CC's notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lecture4：Automatic Differentiation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/tang-jiapeng/tang-jiapeng.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    tang-jiapeng.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  🏡 Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../langs/" class="md-tabs__link">
          
  
    
  
  Langs

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  Core

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../tools/" class="md-tabs__link">
          
  
    
  
  Tools

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../life/" class="md-tabs__link">
          
  
    
  
  Life

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="0X10CC&#39;s notes" class="md-nav__button md-logo" aria-label="0X10CC's notes" data-md-component="logo">
      
  <img src="../../../logo.ico" alt="logo">

    </a>
    0X10CC's notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tang-jiapeng/tang-jiapeng.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    tang-jiapeng.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    🏡 Home
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            🏡 Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../langs/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Langs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Langs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++零碎杂记
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            C++零碎杂记
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/%E9%9B%B6%E7%A2%8E%E6%9D%82%E8%AE%B0/%E9%A1%B6%E5%B1%82const%E4%B8%8E%E5%BA%95%E5%B1%82const/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    顶层const与底层const
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/%E9%9B%B6%E7%A2%8E%E6%9D%82%E8%AE%B0/%E5%80%BC%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%B3%E5%80%BC%E5%BC%95%E7%94%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    值类型与右值引用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/%E9%9B%B6%E7%A2%8E%E6%9D%82%E8%AE%B0/%E6%95%B0%E7%BB%84%E6%8C%87%E9%92%88%E4%B8%8E%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数组指针与函数指针
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/%E9%9B%B6%E7%A2%8E%E6%9D%82%E8%AE%B0/C%2B%2B%E7%B1%BB%E5%AF%B9%E8%B1%A1%E5%B8%83%E5%B1%80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++类对象布局
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/%E9%9B%B6%E7%A2%8E%E6%9D%82%E8%AE%B0/C%2B%2B%E4%B8%AD%E7%9A%84%E5%A4%9A%E6%80%81%E4%B8%8ERTTI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++中的多态与RTTI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Effective Modern C++
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Effective Modern C++
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/effective/item1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    item1：理解模板类型推导
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/effective/item2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    item2：理解auto类型推导
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/effective/item3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    item3：理解decltype
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/effective/item7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    item7：区别使用()和{}创建对象
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/effective/item9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    item9：优先考虑别名声明而非typedef
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../langs/cpp/effective/item23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    item23：理解std::move和std::forward
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Core
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CMU15-213：CSAPP
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            CMU15-213：CSAPP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter1：计算机系统漫游
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter2：信息的表示和处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter3：程序的机器级表示
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter4：处理器体系结构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter5：优化程序性能
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter6：存储器层次结构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter7：链接
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter8：异常控制流
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter9：虚拟内存
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter10：系统级I/O
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter11：网络编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/ch12/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chapter12：并发编程
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CMU10-714：Deep Learning Systems
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            CMU10-714：Deep Learning Systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lecture2：ML Refresher / Softmax Regression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lecture3：Manual Neural Networks / Backprop
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lecture4：Automatic Differentiation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lecture4：Automatic Differentiation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-不同微分方法的介绍" class="md-nav__link">
    <span class="md-ellipsis">
      1 不同微分方法的介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-微分在机器学习中如何应用" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 微分在机器学习中如何应用？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-数值微分" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 数值微分
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-符号微分" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 符号微分
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-计算图" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 计算图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-正向模式自动微分" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 正向模式自动微分
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-反向模式自动微分" class="md-nav__link">
    <span class="md-ellipsis">
      2 反向模式自动微分
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 反向模式自动微分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-例子" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-multiple-path情形" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 multiple path情形
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-反向ad算法" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 反向AD算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-通过扩展计算图的反向ad" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 通过扩展计算图的反向AD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-反向ad-vs-反向传播" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 反向AD vs 反向传播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-张量上的反向模式" class="md-nav__link">
    <span class="md-ellipsis">
      2.6 张量上的反向模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-在其他数据结构上的反向ad" class="md-nav__link">
    <span class="md-ellipsis">
      2.7 在其他数据结构上的反向AD
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lecture5：Automatic Differentiation Implementation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lecture6：Optimization
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../tools/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../life/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Life
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Life
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-不同微分方法的介绍" class="md-nav__link">
    <span class="md-ellipsis">
      1 不同微分方法的介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-微分在机器学习中如何应用" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 微分在机器学习中如何应用？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-数值微分" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 数值微分
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-符号微分" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 符号微分
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-计算图" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 计算图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-正向模式自动微分" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 正向模式自动微分
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-反向模式自动微分" class="md-nav__link">
    <span class="md-ellipsis">
      2 反向模式自动微分
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 反向模式自动微分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-例子" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-multiple-path情形" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 multiple path情形
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-反向ad算法" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 反向AD算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-通过扩展计算图的反向ad" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 通过扩展计算图的反向AD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-反向ad-vs-反向传播" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 反向AD vs 反向传播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-张量上的反向模式" class="md-nav__link">
    <span class="md-ellipsis">
      2.6 张量上的反向模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-在其他数据结构上的反向ad" class="md-nav__link">
    <span class="md-ellipsis">
      2.7 在其他数据结构上的反向AD
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="automatic-differentiation">Automatic Differentiation<a class="headerlink" href="#automatic-differentiation" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5Z"/></svg></span> 约 3052 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3L12.5 13Z"/></svg></span> 预计阅读时间 10 分钟</p>
</div>
<h2 id="1-不同微分方法的介绍">1 不同微分方法的介绍<a class="headerlink" href="#1-不同微分方法的介绍" title="Permanent link">&para;</a></h2>
<h2 id="11-微分在机器学习中如何应用">1.1 微分在机器学习中如何应用？<a class="headerlink" href="#11-微分在机器学习中如何应用" title="Permanent link">&para;</a></h2>
<p>回顾：每个机器学习算法都包含三个不同的元素。计算关于假设类参数的损失函数梯度是机器学习中最常见的操作：</p>
<p><center><img alt="alt text" src="../image/QQ_1721283310679.png" width="500" /></center></p>
<h2 id="12-数值微分">1.2 数值微分<a class="headerlink" href="#12-数值微分" title="Permanent link">&para;</a></h2>
<p>数值微分是根据定义直接计算梯度：</p>
<div class="arithmatex">\[
\frac{\partial f(\theta)}{\partial \theta_i}=\lim _{\epsilon \rightarrow 0} \frac{f\left(\theta+\epsilon e_i\right)-f(\theta)}{\epsilon}
\]</div>
<p>一种更精确的近似梯度的方法（根据泰勒展开）：</p>
<div class="arithmatex">\[
\frac{\partial f(\theta)}{\partial \theta_i}=\frac{f\left(\theta+\epsilon e_i\right)-f\left(\theta-\epsilon e_i\right)}{2 \epsilon}+o\left(\epsilon^2\right)
\]</div>
<p>尽管如此，在实践中上式用得也不多，因为仍然存在数值误差，需要使用很小的<span class="arithmatex">\(\delta\)</span>做计算。</p>
<p>另外，这里对每个维度都需要计算做两次正向计算，总体的计算代价也太大。不过，该方法可以用来检查自动微分计算出来的结果是否合理。为了避免选取<span class="arithmatex">\(d\)</span>个单位向量，使用从球面空间中采样的向量<span class="arithmatex">\(\delta\)</span>，则如果自动微分框架计算的结果<span class="arithmatex">\(\nabla_\theta f(\theta)\)</span>正确，有：</p>
<div class="arithmatex">\[
\delta^T \nabla_\theta f(\theta)=\frac{f(\theta+\epsilon \delta)-f(\theta-\epsilon \delta)}{2 \epsilon}+o\left(\epsilon^2\right)
\]</div>
<h2 id="13-符号微分">1.3 符号微分<a class="headerlink" href="#13-符号微分" title="Permanent link">&para;</a></h2>
<p>通过求和、乘积和链式法则推导出梯度，这种方法跟人手推公式的思路类似，比较直观。</p>
<div class="arithmatex">\[
\begin{aligned}
\frac{\partial(f(\theta)+g(\theta))}{\partial \theta}&amp;=\frac{\partial f(\theta)}{\partial \theta}+\frac{\partial g(\theta)}{\partial \theta}\\
\frac{\partial(f(\theta) g(\theta))}{\partial \theta}&amp;={g}(\theta) \frac{\partial f(\theta)}{\partial \theta}+{f}(\theta) \frac{\partial g(\theta)}{\partial \theta} \\
\frac{\partial f(g(\theta))}{\partial \theta}&amp;=\frac{\partial f(g(\theta))}{\partial g(\theta)} \frac{\partial g(\theta)}{\partial \theta}
\end{aligned}
\]</div>
<p>但是会引起很多重复计算，例如下面这个例子：</p>
<div class="arithmatex">\[
\begin{aligned}
f(\theta)&amp;=\prod_{i=0}^n \theta_i\\
\frac{f(\theta)}{\partial \theta_k}&amp;=\prod_{j \neq k}^n \theta_j
\end{aligned}
\]</div>
<p>计算这个梯度需要<span class="arithmatex">\(n(n-1)\)</span>次乘法，尽管稍微优化一下计算过程能降低到<span class="arithmatex">\(n\)</span>次乘法，但是如果只是简单的把规则实现出来，就会忽视掉很多可以被复用的结果。但是，有时候，的确可以把自动微分看做是符号微分的一种简洁形式</p>
<h2 id="14-计算图">1.4 计算图<a class="headerlink" href="#14-计算图" title="Permanent link">&para;</a></h2>
<p>自动微分的核心内容是计算图，其本质是一个有向无环图，表示某个特定函数的所有操作，例如下图：</p>
<p><center><img alt="alt text" src="../image/QQ_1721284270590.png" width="700" /></center></p>
<p>注意同样的函数可以有不同的计算图，例如对三个元素<span class="arithmatex">\(a\)</span>、<span class="arithmatex">\(b\)</span>、<span class="arithmatex">\(c\)</span>相乘的结果，可以先计算<span class="arithmatex">\(a\)</span>和<span class="arithmatex">\(b\)</span>的乘积，也可以先计算<span class="arithmatex">\(b\)</span>和<span class="arithmatex">\(c\)</span>的乘积。因此，计算图也可以看做是对函数操作计算顺序的定义说明</p>
<p>计算图中的每个节点都是一个中间计算过程，而边表示输入与输出之间的关系。例如，<span class="arithmatex">\(v_3\)</span>对应的节点的输入就是<span class="arithmatex">\(v_1\)</span>的输出，做<span class="arithmatex">\(ln\)</span>操作后的结果输出给<span class="arithmatex">\(v_6\)</span>作为其输入</p>
<h2 id="15-正向模式自动微分">1.5 正向模式自动微分<a class="headerlink" href="#15-正向模式自动微分" title="Permanent link">&para;</a></h2>
<p>即在有了计算图以后，就可以根据拓扑排序的顺序计算各个中间结点的结果，进而得到最后结果。而且，可以通过该图得到微分的结果，这种方法叫做 <strong>正向模式自动微分</strong>：从图中最初的节点开始，顺着正向计算的过程（也是计算图正向拓扑逻辑的过程）对每个中间节点计算其对原始输入的导数。</p>
<p>记</p>
<div class="arithmatex">\[
\dot{v}_i=\frac{\partial v_i}{\partial x_1}
\]</div>
<p>则对上面的计算图，可以计算正向自动微分结果如下</p>
<div class="arithmatex">\[
\begin{aligned}
&amp; \dot{v}_1=1 \\
&amp; \dot{v}_2=0 \\
&amp; \dot{v}_3=\dot{v}_1 / v_1=0.5 \\
&amp; \dot{v}_4=\dot{v}_1 v_2+\dot{v}_2 v_1=1 \times 5+0 \times 2=5 \\
&amp; \dot{v}_5=\dot{v}_2 \cos v_2=0 \times \cos 5=0 \\
&amp; \dot{v}_6=\dot{v}_3+\dot{v}_4=0.5+5=5.5 \\
&amp; \dot{v}_7=\dot{v}_6-\dot{v}_5=5.5-0=5.5
\end{aligned}
\]</div>
<p>因此：</p>
<div class="arithmatex">\[
\frac{\partial y}{\partial x_1}=\dot{v_7}=5.5
\]</div>
<p>对于正向模式自动微分而言，它是从正向计算图的起点开始计算，而起点的中间变量对输入的梯度很容易可以获取到：如果变量和输入相同，那么梯度就为1，否则就是0。接着，对其它中间节点，就可以通过计算该节点对输入的导数，结合输入的自动微分结果，得到该节点的自动微分结果</p>
<p>正向模式自动微分也存在一定的局限性。对函数<span class="arithmatex">\(f:\mathbb R^n \to \mathbb R^k\)</span>，由于该方法对一个参数正向计算一遍就可以获得损失对它的梯度结果，因此当<span class="arithmatex">\(n\)</span>比较小的时候，计算量较小。但是在深度学习的场景下，通常输出是标量，而输入参数数量庞大，使用这种方法就会造成大量的计算代价。所以，需要设计另一种方法来计算自动微分结果——这也就引出了本次课的主题：反向模式自动微分</p>
<h2 id="2-反向模式自动微分">2 反向模式自动微分<a class="headerlink" href="#2-反向模式自动微分" title="Permanent link">&para;</a></h2>
<h3 id="21-例子">2.1 例子<a class="headerlink" href="#21-例子" title="Permanent link">&para;</a></h3>
<p>反向模式自动微分是从结果反推到输入的过程。由于要计算得到一个标量可能需要有多个输入，因此在该场景下定义一个新的术语伴随值（adjoint）：</p>
<div class="arithmatex">\[
\bar{v}_i=\frac{\partial y}{\partial v_i}
\]</div>
<p>然后我们可以按照计算图的反向拓扑顺序迭代计算<span class="arithmatex">\(\bar{v}_i\)</span></p>
<div class="arithmatex">\[
\begin{aligned}
&amp; \overline{v_7}=\frac{\partial y}{\partial v_7}=1 \\
&amp; \overline{v_6}=\bar{v}_7 \frac{\partial v_7}{\partial v_6}=\overline{v_7} \times 1=1 \\
&amp; \overline{v_5}=\bar{v}_7 \frac{\partial v_7}{\partial v_5}=\overline{v_7} \times(-1)=-1 \\
&amp; \overline{v_4}=\overline{v_6} \frac{\partial v_6}{\partial v_4}=\overline{v_6} \times 1=1 \\
&amp; \overline{v_3}=\overline{v_6} \frac{\partial v_6}{\partial v_3}=\overline{v_6} \times 1=1 \\
&amp; \overline{v_2}=\overline{v_5} \frac{\partial v_5}{\partial v_2}+\overline{v_4} \frac{\partial v_4}{\partial v_2}=\overline{v_5} \times \cos v_2+\bar{v}_4 \times v_1=-0.284+2=1.716 \\
&amp; \overline{v_1}=\bar{v}_4 \frac{\partial v_4}{\partial v_1}+\overline{v_3} \frac{\partial v_3}{\partial v_1}=\overline{v_4} \times v_2+\bar{v}_3 \frac{1}{v_1}=5+\frac{1}{2}=5.5
\end{aligned}
\]</div>
<p>因此，通过巧妙地定义伴随值，可以从函数的结果递归计算中间节点的梯度：下一个节点的伴随值乘以输出对输入的偏导数。这样，通过一次反向传播，就可以得到所有参数的梯度</p>
<h3 id="22-multiple-path情形">2.2 multiple path情形<a class="headerlink" href="#22-multiple-path情形" title="Permanent link">&para;</a></h3>
<p>当<span class="arithmatex">\(v_1\)</span>被用于计算图的多条路径上（<span class="arithmatex">\(v_2\)</span>和<span class="arithmatex">\(v_3\)</span>）：</p>
<p><center><img alt="alt text" src="../image/QQ_1721285622828.png" width="300" /></center></p>
<p>即<span class="arithmatex">\(y=f(v_2, v_3)\)</span>，那么：</p>
<div class="arithmatex">\[
\overline{v_1}=\frac{\partial y}{\partial v_1}=\frac{\partial f\left(v_2, v_3\right)}{\partial v_2} \frac{\partial v_2}{\partial v_1}+\frac{\partial f\left(v_2, v_3\right)}{\partial v_3} \frac{\partial v_3}{\partial v_1}=\overline{v_2} \frac{\partial v_2}{\partial v_1}+\overline{v_3} \frac{\partial v_3}{\partial v_1}
\]</div>
<p>定义部分伴随：</p>
<div class="arithmatex">\[
\overline{v_{i \rightarrow j}}=\bar{v}_j \frac{\partial v_j}{\partial v_i}
\]</div>
<p>则有：</p>
<div class="arithmatex">\[
\bar{v}_i=\sum_{j \in \text { next }(i)} \overline{v_{i \rightarrow j}}
\]</div>
<p>总结后即可得到反向AD算法。</p>
<h3 id="23-反向ad算法">2.3 反向AD算法<a class="headerlink" href="#23-反向ad算法" title="Permanent link">&para;</a></h3>
<p><center><img alt="alt text" src="../image/QQ_1721285893024.png" width="700" /></center></p>
<p>由于是根据反向拓扑排序确定的节点计算顺序，在计算节点<span class="arithmatex">\(i\)</span>的梯度时，其后续的所有节点梯度都已经计算完毕，即所有以节点<span class="arithmatex">\(i\)</span>为输入的节点都已经被访问过，相关的部分伴随值都已经备妥</p>
<h3 id="24-通过扩展计算图的反向ad">2.4 通过扩展计算图的反向AD<a class="headerlink" href="#24-通过扩展计算图的反向ad" title="Permanent link">&para;</a></h3>
<p>在具体实现时，一个问题是使用什么样的数据结构存储adjoint_i（<span class="arithmatex">\(\bar{v}_i\)</span>）和partial_adjoint_i_j（<span class="arithmatex">\(\overline{v_{i \rightarrow j}}\)</span>）。虽然自然的想法是使用numpy的多维数组，但是真实实现时可以使用计算图来表达。例如，假设要计算的函数为
，对应的正向计算图和第一步反向传播计算图如下（id这里是相等函数）。这一步得到了<span class="arithmatex">\(v_4\)</span></p>
<p><center><img alt="alt text" src="../image/QQ_1721286203484.png" width="700" /></center></p>
<p>接下来第一次进入内层for循环，需要遍历<span class="arithmatex">\(v_4\)</span>的输入计算<span class="arithmatex">\(\overline{v_{k \rightarrow 4}}\)</span>。对于<span class="arithmatex">\(k = 2\)</span>，有
<span class="arithmatex">\(\overline{v_{2 \rightarrow 4}} = \overline{v_4} \cdot \frac{\partial v_4}{\partial v_2}\)</span>。
由于<span class="arithmatex">\(v_4 = v_2 \times v_3\)</span>，因此<span class="arithmatex">\(\overline{v_4} \cdot \frac{\partial v_4}{\partial v_2} = \overline{v_4} \cdot v_3\)</span>。相应地，<span class="arithmatex">\(v_3\)</span>只有一个输入（在前向图中表现为<span class="arithmatex">\(v_3\)</span>只有一个输出），因此可以直接计算得到<span class="arithmatex">\(\overline{v_3} = v_2 \cdot \overline{v_4}\)</span>。</p>
<p><center><img alt="alt text" src="../image/QQ_1721286645274.png" width="700" /></center></p>
<p>接下来在外层for循环会遍历<span class="arithmatex">\(v_3\)</span>、<span class="arithmatex">\(v_2\)</span>、<span class="arithmatex">\(v_1\)</span>，最后得到如下扩展计算图。扩展计算图不仅包含了正向计算信息，计算中间变量，还包含了梯度计算信息，同时计算各个伴随值。而且图更加灵活，可以接受任意输入</p>
<p><center><img alt="alt text" src="../image/QQ_1721286750276.png" width="700" /></center></p>
<p>这里有两点需要再说明一下。一是计算<span class="arithmatex">\(v_2\)</span>时，因为在正向计算图中<span class="arithmatex">\(v_2\)</span>有两个输出，所以在反向计算图中<span class="arithmatex">\(v_2\)</span>有两个输入，对应部分伴随值<span class="arithmatex">\(\overline{v_{2 \rightarrow 3}}\)</span>和<span class="arithmatex">\(\overline{v_{2 \rightarrow 4}}\)</span>，然后要根据全微分定理把它们相加来得到<span class="arithmatex">\(\overline{v_2}\)</span>。二是计算<span class="arithmatex">\(v_1\)</span>时，根据定义有<span class="arithmatex">\(\overline{v_1} = \overline{v_2} \cdot \frac{\partial v_2}{\partial v_1}\)</span>。而<span class="arithmatex">\(v_2 = \exp(v_1)\)</span>，所以<span class="arithmatex">\(\frac{\partial v_2}{\partial v_1} = \exp(v_1) = v_2\)</span>不变。因此在反向计算图中可以直接复用<span class="arithmatex">\(v_2\)</span>这个节点，即<span class="arithmatex">\(\overline{v_1} = \overline{v_2} \cdot v_2\)</span>，不需要再额外引入指数函数计算。</p>
<h3 id="25-反向ad-vs-反向传播">2.5 反向AD vs 反向传播<a class="headerlink" href="#25-反向ad-vs-反向传播" title="Permanent link">&para;</a></h3>
<p><center><img alt="alt text" src="../image/QQ_1721287020712.png" width="700" /></center></p>
<p>在看到反向模式自动微分对应的计算图以后，很容易引出的问题是反向模式自动微分和反向传播之间有什么联系和区别。</p>
<p>做反向传播时，只构建正向计算图，在同样的图上计算梯度，不会在反向传播的过程中创建新的节点，用于第一代深度学习框架（caffe、cuda-convnet）</p>
<p>为什么现在的框架（例如TensorFlow、PyTorch）都使用反向模式自动微分，而不直接使用反向传播了呢？有时候我们对梯度的函数感兴趣，而反向传播只能解决如何计算梯度的问题，但是难以计算梯度的梯度——但是在反向模式自动微分中，由于我们有一个独立的计算图，就可以通过进一步扩展节点得到想要的结果。另外，由于反向模式自动微分的产出结果是计算图，我们可以直接在上面运行一次计算过程，进而有更多机会对这个图做进一步优化，例如在上面例子中去掉id操作</p>
<h3 id="26-张量上的反向模式">2.6 张量上的反向模式<a class="headerlink" href="#26-张量上的反向模式" title="Permanent link">&para;</a></h3>
<p>上面讲述的是标量对标量的操作，不过上述方法可以容易扩展到多维向量和张量，只需要扩展伴随值到伴随张量上即可，对于高维情形，利用向量微积分即可，考虑下例：</p>
<p><center><img alt="alt text" src="../image/QQ_1721287246512.png" width="300" /></center></p>
<p>前向计算为：</p>
<div class="arithmatex">\[
\begin{aligned}
 Z&amp;=X W \\
 v&amp;=f(Z)
\end{aligned}
\]</div>
<p>对于中间变量矩阵<span class="arithmatex">\(Z\)</span>，根据矩阵乘法法则，有<span class="arithmatex">\(Z_{ij} = \sum_{k} X_{ik} W_{kj}\)</span>。</p>
<p>因此反过来，对于伴随值<span class="arithmatex">\(\overline{X_{i, k}}\)</span>，有：</p>
<div class="arithmatex">\[
\overline{X_{i, k}}=\sum_j \frac{\partial z_{i, j}}{\partial X_{i, k}} \bar{Z}_{i, j}=W_{k, j} \bar{Z}_{i, j}
\]</div>
<p>写成矩阵形式就是<span class="arithmatex">\(\bar{X}=\bar{Z} W^T\)</span>，其中伴随张量为</p>
<div class="arithmatex">\[
\bar{Z}=\left[\begin{array}{ccc}
\frac{\partial y}{\partial z_{1,1}} &amp; \ldots &amp; \frac{\partial y}{\partial z_{1, n}} \\
\vdots &amp; \ldots &amp; \vdots \\
\frac{\partial y}{\partial z_{m, 1}} &amp; \ldots &amp; \frac{\partial y}{\partial z_{m, n}}
\end{array}\right]
\]</div>
<h3 id="27-在其他数据结构上的反向ad">2.7 在其他数据结构上的反向AD<a class="headerlink" href="#27-在其他数据结构上的反向ad" title="Permanent link">&para;</a></h3>
<p>需要注意有时候中间变量或者输入甚至不是张量形式，而是某种数据结构。例如输入<code>d = {"cat": a0, "dog": a_1}</code>，然后对该输入进行的中间计算是查找：<code>b = d["cat"]</code>。这时可以将伴随值“升级”为伴随数据结构，如下</p>
<p><center><img alt="alt text" src="../image/QQ_1721287697876.png" width="700" /></center></p>
<p>简而言之，“伴随值”最好和正向传播中对应的值有同样的数据结构，这样示例中的算法就可以正常工作。</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-08-09T13:17:58+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-08-09</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2024-08-09T13:17:58+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-08-09</span>
  </span>

    
    
    
  </aside>


  



<div id="__comments">

<h3>颜色主题调整</h3>

<!-- <div class="tx-switch">
<button data-md-color-scheme="default"><code>default</code></button>
<button data-md-color-scheme="slate"><code>slate</code></button>
</div>

<script>
var buttons = document.querySelectorAll("button[data-md-color-scheme]")
buttons.forEach(function(button) {
        button.addEventListener("click", function() {
        var attr = this.getAttribute("data-md-color-scheme")
        document.body.setAttribute("data-md-color-scheme", attr)
        localStorage.setItem("data-md-color-scheme",attr);
        updateScheme();
        })
})
</script> -->

<div class="tx-switch">
<button class="button1" data-md-color-primary="red" style="background-color:red">red</button>
<button class="button1" data-md-color-primary="pink" style="background-color:pink;color:black">pink</button>
<button class="button1" data-md-color-primary="purple" style="background-color:purple">purple</button>
<button class="button1" data-md-color-primary="indigo" style="background-color:indigo">indigo</button>
<button class="button1" data-md-color-primary="blue" style="background-color:blue">blue</button>
<button class="button1" data-md-color-primary="cyan" style="background-color:cyan;color:black">cyan</button>
<button class="button1" data-md-color-primary="teal" style="background-color:teal">teal</button>
<button class="button1" data-md-color-primary="green" style="background-color:green">green</button>
<button class="button1" data-md-color-primary="lime" style="background-color:lime;color:black">lime</button>
<button class="button1" data-md-color-primary="orange" style="background-color:orange;color:black">orange</button>
<button class="button1" data-md-color-primary="brown" style="background-color:brown;border-radius=3px">brown</button>
<button class="button1" data-md-color-primary="grey" style="background-color:grey">grey</button>
<button class="button1" data-md-color-primary="black" style="background-color:black">black</button>
<button class="button1" data-md-color-primary="white" style="background-color:white;color:black">white</button>
</div>

<script>
var buttons = document.querySelectorAll("button[data-md-color-primary]")
buttons.forEach(function(button) {
        button.addEventListener("click", function() {
        var attr = this.getAttribute("data-md-color-primary")
        document.body.setAttribute("data-md-color-primary", attr)
        localStorage.setItem("data-md-color-primary",attr);
        })
})
</script>

<h2 ><!-- 评论 -->评论区~</h2>

有用的话请给我个赞和 star => <a href="https://github.com/Tangjp-wraith/Tangjp-wraith.github.io"><img alt="GitHub stars" src="https://img.shields.io/github/stars/Tangjp-wraith/Tangjp-wraith.github.io.svg?style=plastic&amp;label=Stars"></a>

</br>

快来跟我聊天~

</div>

<script src="https://giscus.app/client.js" data-repo="Tangjp-wraith/discussion" data-repo-id="R_kgDOLRJCPw"
    data-category="General" data-category-id="DIC_kwDOLRJCP84CdJdO" data-mapping="pathname" data-strict="0"
    data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark" data-lang="zh-CN"
    crossorigin="anonymous" async>
    </script>

<!-- Synchronize Giscus theme with palette -->
<script>
var giscus = document.querySelector("script[src*=giscus]")

/* Set palette on initial load */
var palette = __md_get("__palette")
if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light"
    giscus.setAttribute("data-theme", theme) 
}

/* Register event handlers after documented loaded */
document.addEventListener("DOMContentLoaded", function() {
    var ref = document.querySelector("[data-md-component=palette]")
    ref.addEventListener("change", function() {
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"
        localStorage.setItem("data-md-color-scheme", palette.color.scheme === "slate" ? "slate" : "default");
        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame")
        frame.contentWindow.postMessage(
        { giscus: { setConfig: { theme } } },
        "https://giscus.app"
        )
    }
    })
})
</script>
                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      本页面的全部内容在 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA 4.0</a> 和 <a href="https://github.com/zTrix/sata-license">SATA</a> 协议之条款下提供，附加条款亦可能应用
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "content.code.annotate", "navigation.indexes", "navigation.top", "toc.follow"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../../js/timeago.min.js"></script>
      
        <script src="../../../js/timeago_mkdocs_material.js"></script>
      
        <script src="../../../from_oi_wiki/js/extra.js"></script>
      
        <script src="../../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../../js/tablesort.js"></script>
      
        <script src="../../../termynal.js"></script>
      
    
  </body>
</html>